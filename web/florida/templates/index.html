<html>
    <title>Research Scraper</title>
    <link href="../static/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <body>
        {% raw %}
        <h1>Research Scraper</h1>
        <div id="search_tool">
            <input v-model="query" type=text />
            <button v-on:click="search" >search</button>
        </div>
        <div v-if="papers" id="result_table" >
            <h3>Searching Result : {{papers.length}} was found</h3>
            <table class="table table-bordered" >
                <tr>
                    <th v-for="field in visible_fields"> {{field}} </th>
                    <th> action </th>
                <tr/>
                <tr v-for="(paper, index) in papers">
                    <td v-for="field in visible_fields">
                        <template v-if="field==='title' && paper['is_pdf'] == 1">
                            <a v-bind:href="paper['url']">{{paper[field]}}</a>
                        </template>
                        <template v-else>{{paper[field]}}</template>
                    </td>
                    <td><button v-on:click="edit" v-bind:index="index" data-toggle="modal" data-target="#edit_tool">edit</button></td>
                </tr>
            </table>
        </div>
        <div class="modal fade" id="edit_tool" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel">
                            Edit Current Row
                        </h4>
                    </div>
                    <div class="modal-body">
                        Title : <input v-model="title" class="form-control" type="text" /><br/>
                        Authors : <input v-model="authors" class="form-control" type="text" /><br/>
                        Publication_date : <input v-model="publication_date" class="form-control" type="text" /><br/>
                        Conference : <input v-model="conference" class="form-control" type="text" /><br/>
                        Journal : <input v-model="journal" class="form-control" type="text" /><br/>
                        Publisher : <input v-model="publisher" class="form-control" type="text" /><br/>
                        Total_citations : <input v-model="total_citations" class="form-control" type="text" /><br/>
                        Url : <input v-model="url" class="form-control" type="text" /><br/>
                    </div>
                    <div class="modal-footer">
                        <button v-on:click="delete_paper" type="button" class="btn btn-danger">
                            Delete
                        </button>
                        <button v-on:click="update" type="button" class="btn btn-primary">
                            Submit
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endraw %}
        <script>
            var edit_tool = new Vue({
                el: '#edit_tool',
                data: {
                    index: 0,
                    title: "",
                    authors: "",
                    publication_date: "",
                    conference: "",
                    journal: "",
                    publisher: "",
                    total_citations: "",
                    url: ""
                },
                methods: {
                    edit: function(event){
                        this.index = event.target.getAttribute("index");
                        this.title = result_table.papers[this.index]['title']
                        this.authors = result_table.papers[this.index]['authors']
                        this.publication_date = result_table.papers[this.index]['publication_date']
                        this.conference = result_table.papers[this.index]['conference']
                        this.journal = result_table.papers[this.index]['journal']
                        this.publisher = result_table.papers[this.index]['publisher']
                        this.total_citations = result_table.papers[this.index]['total_citations']
                        this.url = result_table.papers[this.index]['url']
                    },
                    update: function(){
                        axios.put('/api/papers/' + result_table.papers[this.index]['id'],
                            {
                                title: this.title,
                                authors: this.authors,
                                publication_date: this.publication_date,
                                conference: this.conference,
                                journal: this.journal,
                                publisher: this.publisher,
                                total_citations: this.total_citations,
                                is_pdf: this.url == "" ? "0":"1",
                                url: this.url
                            }
                        ).then(function(response){
                            if(response.status == "200"){
                                alert("Update Success !")
                            } else{
                                alert("Update Fail !")
                            }
                            $('#edit_tool').modal('hide');
                            search_tool.search()
                        }).catch(function(response){
                            console.log(response)
                        })
                    },
                    delete_paper: function(){
                        axios.delete('/api/papers/' + result_table.papers[this.index]['id'])
                            .then(function(response){
                                if(response.status == "200"){
                                    alert("Delete Success !")
                                } else{
                                    alert("Delete Fail !")
                                }
                                $('#edit_tool').modal('hide');
                                search_tool.search()
                            }).catch(function(response){
                                console.log(response)
                            })
                        ;
                    }
                }
            });
            var result_table = new Vue({
                el: '#result_table',
                data: {
                    visible_fields: [
                        "title", "authors",
                        "publication_date",
                        "conference", "journal",
                        "publisher", "total_citations",
                    ],

                    papers: undefined
                },
                methods: {
                    edit: edit_tool.edit
                }
            });
            var search_tool = new Vue({
                el: '#search_tool',
                data: {
                    query:""
                },
                methods: {
                    search: function(){
                        axios.get('/api/papers/?query=' + this.query)
                            .then(function (response){
                                result_table.papers = response.data.papers
                            }).catch(function (error){
                                console.log(error);
                            });
                    }
                }
            });
        </script>
        <script src="../static/js/jquery-3.2.1.slim.min.js"></script>
        <script src="../static/js/bootstrap.min.js"></script>
    </body>
</html>
